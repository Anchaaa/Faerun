namespace = ZHE

########################JOINING############################

#From on_character_ask_to_join_society
character_event = {
    id = ZHE.100
	hide_window = yes
    is_triggered_only = yes
    trigger = {
    	FROM = { leader = { society_member_of = black_network } }
    }
    immediate = {
    	if = { #Find a non-prisoner member
    		limit = { FROM = { leader = { prisoner = yes } } }
    		FROM = {
    			any_society_member = {
    				limit = {
    					society_member_of = black_network
    					society_rank == 4
    					prisoner = no
    				}
    				character_event = { id = ZHE.101 }
    				break = yes
    			}
    			any_society_member = {
    				limit = {
    					society_member_of = black_network
    					society_rank == 3
    					prisoner = no
    				}
    				character_event = { id = ZHE.101 }
    				break = yes
    			}
    			any_society_member = {
    				limit = {
    					society_member_of = black_network
    					society_rank == 2
    					prisoner = no
    				}
    				character_event = { id = ZHE.101 }
    				break = yes
    			}
    			any_society_member = {
    				limit = {
    					society_member_of = black_network
    					society_rank == 1
    					prisoner = no
    				}
    				character_event = { id = ZHE.101 }
    				break = yes
    			}
    		}
			#Everyone is somehow in prison so just use teh leader anyway
    	}
    	FROM = { leader = { character_event = { id = ZHE.101 } } }
    }
}

#Ping event
character_event = {
    id = ZHE.101
	hide_window = yes
    is_triggered_only = yes
    immediate = {
    	FROM = { letter_event = { id = ZHE.102 } }
    }
}

#Welcome letter
letter_event = {
    id = ZHE.102
    desc = EVTDESC_ZHE_102
    border = GFX_event_letter_frame_religion

    is_triggered_only = yes

	immediate = { set_character_flag = society_join_block }

    option = {
        name = EVTOPTA_ZHE_102

		join_society = black_network

		clr_character_flag = society_join_block
    }
}

########################AI JOIN AND AI RANK UP###########################

character_event = { #force the AI to join a society
	id = ZHE.110
	hide_window = yes

	only_ruler = yes #leave that unless you want random courtiers in the society

	is_triggered_only = yes

	immediate = {
		if = {
			limit = { #if he's already a member, will force a rank up 25% of the time
				ai = yes
				prisoner = no
				NOT = { trait = incapable }
				society_member_of = black_network
				society_rank <= 3
				society_can_rank_up = yes
			}
			random_list = {
				75 = {}
				25 = {
					society_rank_up = 1
				}
			}
		}
		if = { #force the joining event on AI
			limit = {
				ai = yes
				prisoner = no
				NOT = { trait = incapable }
				is_adult = yes
				is_in_society = no
                                independent = yes
                                is_nomadic = no
			        is_tribal = no
				controls_religion = no
				block_general_event_trigger = no
			}
			character_event = { id = ZHE.111 }
		}
	}
}

character_event = { #AI join event
	id = ZHE.111
	hide_window = yes

	is_triggered_only = yes

	immediate = {
		random_list = {
			60 = { # do nothing
			}
			40 = { # try to join a society 40% of the time
				trigger = { #meet the requirement
					can_join_society = black_network
				}
				modifier = { #things that will make that 40% of the time bigger, can be anything
					factor = 2
					prestige = 200
				}
				join_society = black_network #join the society
				random_list = { # Artificially increase society influence for balance purposes, not really useful in my opinion.
					75 = {
						modifier = {
							factor = 0
							society_influence >= 30
						}
					}
					25 = {
					}
				}
				if = { # Make grandmaster is there is none
					limit = {
						NOT = {
							society = {
								any_society_member = {
									is_society_grandmaster = yes
								}
							}
						}
					}
					set_society_grandmaster = yes
				}
			}
		}
	}
}

#######################Rank UP#############################

#Hidden start: Send the rank-up request to the current Grandmaster (delayed event on self, from decision to rank up)
character_event = {
	id = ZHE.120

	hide_window = yes

	trigger = { #has pressed the button
		has_character_flag = has_sent_request_to_rank_up
	}

	is_triggered_only = yes

	immediate = {
		if = { #if he's still a member
			limit = { is_in_society = yes }
			random_society_member = { #will send the request to a random top rank member of the same society
				limit = {
					is_society_grandmaster = yes
					same_society_as = ROOT
				}
				character_event = { id = ZHE.121 } # send request to Grand Master.
			}
		}
		if = { #if he's not a member
			limit = { is_in_society = no }
			clr_character_flag = has_sent_request_to_rank_up
		}
	}
}

#Grandmaster gets the rank-up request
character_event = {
	id = ZHE.121

	hide_window = yes

	is_triggered_only = yes

	immediate = {
		event_target:rank_up_target = { letter_event = { id = ZHE.122 } } #send it back
	}
}

#Grand master approves my request
letter_event = {
	id = ZHE.122
	desc = EVTDESC_ZHE_122
	border = GFX_event_letter_frame_war

	trigger = {
		society_rank < 4 #cannot rank up past 4
		has_character_flag = has_sent_request_to_rank_up
	}

	is_triggered_only = yes

	#Rank up approved
	option = {
		name = EVTOPTA_ZHE_122
		if = { limit = { society_rank < 4 } #if not max rank, rank up
			society_rank_up = 1
		}
		clr_character_flag = has_sent_request_to_rank_up
	}
}

#################################DECISIONS######################################

# ruthless taxation
character_event = {
	id = ZHE.21000
	desc = EVTDESC_ZHE_21000
	picture = GFX_evt_noble_in_castle

	is_triggered_only = yes

	immediate = {
		random_demesne_province = {
			limit = {
				NOR = {
					has_province_modifier = extra_tax
					has_province_modifier = extra_tax_kind
          has_province_modifier = ruthless_tax
					has_province_modifier = ruthless_tax_sneaky
          has_province_modifier = ruthless_tax_heist
			  }
				any_province_holding = {
					OR = {
						holding_type = city
						holding_type = temple
						holding_type = castle
						holding_type = tribal
					}
				}
      }
      save_event_target_as = extra_tax_target
		}
  }
	# Extra Tax on peasants of a random Demesne Province
	option = {
		name = EVTOPTA_ZHE_21000

		ai_chance = {
			factor = 100
		}

		trigger = {
			event_target:extra_tax_target = { always = yes }
		}

		custom_tooltip = {
				text = extort_zhent_custom_tooltip
				hidden_tooltip = {
					any_realm_character = {
                                limit = {
                                      OR = {
                                         religion_group = good_human_pantheon_group
                                         religion_group = elven_pantheon_group
                                         religion_group = dwarven_pantheon_group
                                         trait = kind
                                      }
                                }
                                opinion = {
							                             who = ROOT
						        	                     modifier = opinion_tyrant
							                             months = 60
                                }
          }
        }
    }

		character_event = {	id = ZHE.21100 tooltip = EVTTOOLTIP_ZHE_21100 }

		if = {
			limit = {
				event_target:extra_tax_target = {
						num_of_settlements = 7
					}
				}
			wealth = 150
			break = yes
		}

		if = {
			limit = {
				event_target:extra_tax_target = {
						num_of_settlements = 6
					}
				}
			wealth = 130
			break = yes
		}

		if = {
			limit = {
				event_target:extra_tax_target = {
						num_of_settlements = 5
					}
				}
			wealth = 110
			break = yes
		}

		if = {
			limit = {
				event_target:extra_tax_target = {
						num_of_settlements = 4
					}
				}
			wealth = 90
			break = yes
		}

		if = {
			limit = {
				event_target:extra_tax_target = {
						num_of_settlements = 3
					}
				}
			wealth = 70
			break = yes
		}

		if = {
			limit = {
				event_target:extra_tax_target = {
						num_of_settlements = 2
					}
				}
			wealth = 50
			break = yes
		}

		wealth = 30
  }
}

# Extra Tax on Demesne Province
character_event = {
	id = ZHE.21100
	desc = EVTDESC_ZHE_21100
	picture = GFX_evt_noble_haughty_talking_to_peasants

	is_triggered_only = yes

	# first option High stewardship can trade revolt risk for less tax
	option = {
		name = EVTOPTA_ZHE_21100
		tooltip_info = stewardship

		trigger = {
			stewardship = 15
		}

		event_target:extra_tax_target = {
			add_province_modifier = {
				modifier = ruthless_tax_sneaky
				duration = 1825
			}
		}

		if = {
			limit = {
				OR = {
					trait = kind
          trait = honest
			  }
      }
			effect = {
					remove_trait = kind
          remove_trait = honest
			}
		}
	}

	# second option Peasants upset
	option = {
		name = EVTOPTB_ZHE_21100

    if = {
			limit = {
				OR = {
					trait = kind
					trait = charitable
			  }
      }
			effect = {
					remove_trait = kind
          remove_trait = charitable
			}
		}

		event_target:extra_tax_target = {
			add_province_modifier = {
				modifier = ruthless_tax
				duration = 1825
			}
		}
	}

  # third option High intrigue steal
  option = {
    name = EVTOPTC_ZHE_21100
    tooltip_info = intrigue

    trigger = {
      intrigue = 18
    }

    event_target:extra_tax_target = {
      add_province_modifier = {
        modifier = ruthless_tax_heist
        duration = 3650
      }
    }

    if = {
      limit = {
        OR = {
          trait = kind
          trait = honest
          trait = charitable
        }
      }
      effect = {
          remove_trait = kind
          remove_trait = honest
          remove_trait = charitable
      }
    }
  }
}

### Risky but profitable trade route
# Start of chain (hidden)
character_event = {
	id = ZHE.10100
	is_triggered_only = yes
	hide_window = yes

	immediate = {
		job_treasurer = {
			character_event = { id = ZHE.10101 }
		}
	}
}

# Start of chain (Steward)
character_event = {
	id = ZHE.10101
	is_triggered_only = yes
	desc = EVTDESC_ZHE_10101
	picture = GFX_evt_council
	border = GFX_event_normal_frame_economy

	option = {
		name = EVTOPTA_ZHE_10101
		ai_chance = {
			factor = 1
		}
		save_event_target_as = steward
		FROM = { character_event = { id = ZHE.10102 } }
	}

	option = {
		name = EVTOPTB_ZHE_10101
		ai_chance = {
			factor = 0
		}
	}
}

# Steward presents an opportunity
character_event = {
	id = ZHE.10102
	is_triggered_only = yes
	desc = EVTDESC_ZHE_10102
	picture = GFX_evt_council
	border = GFX_event_normal_frame_economy

	option = {
		name = EVTOPTA_ZHE_10102
		set_character_flag = trade_route_progress
		if = {
			limit = {
				capital_scope = {
					coastal = no
				}
			}
			character_event = { id = ZHE.10103 }
			break = yes
		}
		character_event = { id = ZHE.10104 }
	}

	option = {
		name = EVTOPTB_ZHE_10102
		clr_character_flag = trade_route_progress
	}
}

# Land: setting up a land based trade route
character_event = {
	id = ZHE.10103
	is_triggered_only = yes
	desc = EVTDESC_ZHE_10103
	picture = GFX_evt_merchant_caravan
	border = GFX_event_normal_frame_economy

	option = { # hire crew
		name = EVTOPTA_ZHE_10103
		set_character_flag = trade_is_land
		if = {
			limit = { yearly_income = 200 }
			wealth = -200
		}
		if = {
			limit = {
				yearly_income = 25
				NOT = { yearly_income = 200 }
			}
			scaled_wealth = -1
		}
		if = {
			limit = { NOT = { yearly_income = 25 } }
			wealth = -25
		}
		hidden_tooltip = {
			character_event = { id = ZHE.10105 days = 3 }
		}
	}

	option = { # pillage as we go
		name = EVTOPTB_ZHE_10103
		tooltip_info = martial
    trigger = {
      martial = 15
    }
		set_character_flag = trade_is_land
		if = {
			limit = { yearly_income = 200 }
			wealth = -80
		}
		if = {
			limit = {
				yearly_income = 25
				NOT = { yearly_income = 200 }
			}
			scaled_wealth = -0.4
		}
		if = {
			limit = { NOT = { yearly_income = 25 } }
			wealth = -10
		}
    add_trait = cruel
    hidden_tooltip = {
      character_event = { id = ZHE.10105 days = 3 }
    }
	}

	option = { # this is too expensive
		name = EVTOPTC_ZHE_10103
		clr_character_flag = trade_route_progress
	}
}

# Naval: setting up a naval based trade route
character_event = {
	id = ZHE.10104
	is_triggered_only = yes
	desc = EVTDESC_ZHE_10104
	picture = GFX_evt_busy_trading_dock_republic
	border = GFX_event_normal_frame_economy

	option = { # hire crew
		name = EVTOPTA_ZHE_10104
		if = {
			limit = { yearly_income = 200 }
			wealth = -200
		}
		if = {
			limit = {
				yearly_income = 25
				NOT = { yearly_income = 200 }
			}
			scaled_wealth = -1
		}
		if = {
			limit = { NOT = { yearly_income = 25 } }
			wealth = -25
		}
		hidden_tooltip = {
			character_event = { id = ZHE.10105 days = 3 }
		}
	}

	option = { # piracy
		name = EVTOPTB_ZHE_10104
    tooltip_info = martial
    trigger = {
      martial = 15
    }
		if = {
			limit = { yearly_income = 200 }
			wealth = -80
		}
		if = {
			limit = {
				yearly_income = 25
				NOT = { yearly_income = 200 }
			}
			scaled_wealth = -0.4
		}
		if = {
			limit = { NOT = { yearly_income = 25 } }
			wealth = -10
		}
    add_trait = cruel
    hidden_tooltip = {
      character_event = { id = ZHE.10105 days = 3 }
    }
	}

	option = { # this is too expensive
		name = EVTOPTC_ZHE_10104
		clr_character_flag = trade_route_progress
	}
}
