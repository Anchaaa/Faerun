z_duel_turn_setup = {
    set_variable = { which = "duel_dmg" value = 0}
    set_variable = { which = "dueldmgdice" which = "dueldmgdicebase" }
    set_variable = { which = "atdmgmod" value = "0" }
    
    trigger_switch = { 
        on_trigger = has_character_flag
        duel_action_attack = { 
            if = { 
                limit = {
                    check_variable = { which = "duel_att" value = 1}
                }
                change_variable = { which = "duel_att" value = -1}
                change_variable = { which = "duel_def" value = 1}
            }
        }
        duel_action_defend = { 
            if = { 
                limit = {
                    check_variable = { which = "duel_def" value = 1}
                }
                change_variable = { which = "duel_def" value = -1}
                change_variable = { which = "duel_att" value = 1}
            }
        }
        #barbarian_battleroar = { 
        #    barbarian_battleroar_ability = yes
        #}
        #paladin_divinelight = {
        #    paladin_divinelight_ability = yes
        #}
        #bard_battlesong = { 
        #    bard_battlesong_song = yes
        #}

    } 
    random = { 
        chance = 25
        change_variable = { which = "sp_ac" value = 1}
    }
    zz_ability_flag_clear = yes
    set_variable = { which = "action_nr" value = 0 }
    set_variable = { which = "action_picked" value = 0 }
        # BASIC ACTIONS
}

zz_ability_flag_clear = { 
    clr_character_flag = duel_action_attack
    clr_character_flag = duel_action_defend
    clr_character_flag = duel_action_flee
    clr_character_flag = wizard_attack_cantrip
    clr_character_flag = wizard_defend_cantrip
    clr_character_flag = wizard_stone_skin_cantrip
    clr_character_flag = sorcerer_attack_cantrip
    clr_character_flag = sorcerer_defend_cantrip
    clr_character_flag = bard_dire_song
    clr_character_flag = bard_embolden_song
    clr_character_flag = warlock_doomfire_cantrip
    clr_character_flag = warlock_doom_blast_cantrip
    clr_character_flag = cleric_heal_cantrip
    clr_character_flag = cleric_divine_blessing
    clr_character_flag = druid_bear_strike
    clr_character_flag = druid_bear_skin
    clr_character_flag = druid_regrowth
    clr_character_flag = paladin_holy_smite
    clr_character_flag = paladin_curative
    clr_character_flag = paladin_larger_than_life

    clr_character_flag = fighter_parry
    
    clr_character_flag = barbarian_parry
    
    clr_character_flag = ranger_parry

    clr_character_flag = assassin_dodge

    clr_character_flag = rogue_dodge
    
    clr_character_flag = shadow_dodge

#    clr_character_flag =
#    clr_character_flag =
#    clr_character_flag =
    clr_character_flag = duelhit
}
zz_duel_reward_sequence = { 
    random_list = { 
        1 = { 
            trigger = { 
                z_wizard = yes
            }
            change_variable = { which = "wizxp" value = 25}
        }
        1 = { 
            trigger = { 
                z_bard = yes
            }
            change_variable = { which = "bardxp" value = 25}
        }
        1 = { 
            trigger = { 
                z_warlock = yes
            }
            change_variable = { which = "warlxp" value = 25}
        }
        1 = { 
            trigger = { 
                z_sorcerer = yes
            }
            change_variable = { which = "sorcxp" value = 25}
        }
        1 = { 
            trigger = { 
                z_cleric = yes
            }
            change_variable = { which = "clerxp" value = 25}
        }
        1 = { 
            trigger = { 
                z_paladin = yes
            }
            change_variable = { which = "palaxp" value = 25}
        }
        1 = { 
            trigger = { 
                z_druid = yes
            }
            change_variable = { which = "druixp" value = 25}
        }
        1 = { 
            trigger = {
                z_fighter = yes
            }
            change_variable = { which = "fighxp" value = 25}
        }
        1 = { 
            trigger = {
                z_barbarian = yes
            }
            change_variable = { which = "barbxp" value = 25}
        }
        1 = { 
            trigger = { 
                z_ranger = yes
            }
            change_variable = { which = "rangxp" value = 25}
        }
        1 = { 
            trigger = { 
                z_rogue = yes
            }
            change_variable = { which = "roguxp" value = 25}
        }
        1 = { 
            trigger = {
                z_assassin = yes
            }
            change_variable = { which = "assaxp" value = 25}
        }
        1 = { 
            trigger = {
                z_shadow = yes
            }
            change_variable = { which = "shadxp" value = 25}
        }
    }
    z_class_xp_calc = yes
}

z_duel_round_end_effect = { 
    #Wizard Stone Skin
    if = { 
        limit = {
            check_variable = { which = "wizard_ss_count" value >= 1}
        }
        change_variable = { which = "wizard_ss_count" value = -1}
    }
    if = { 
        limit =  {
            check_variable = { which = "wizard_ss_count" value < 1}
        }
        set_variable = { which = "wizard_ss_count" value = "0"}
        set_variable = { which = "wizard_ss_pot" value = "0"}
    }
    #Bard Emboldening Song
    if = { 
        limit = {
            check_variable = { which = "bard_es_count" value >= 1}
        }
        change_variable = { which = "bard_es_count" value = -1}
    }
    if = { 
        limit =  {
            check_variable = { which = "bard_es_count" value < 1}
        }
        set_variable = { which = "bard_es_pot" value = "0"}
        set_variable = { which = "bard_es_count" value = "0"}
    }
    #Bard Dire Song
    if = { 
        limit = {
            check_variable = { which = "bard_ds_count" value >= 1}
        }
        change_variable = { which = "bard_ds_count" value = -1}
    }
    if = { 
        limit =  {
            check_variable = { which = "bard_ds_count" value < 1}
        }
        set_variable = { which = "bard_ds_pot" value = "0"}
        set_variable = { which = "bard_ds_pot" value = "0"}
    }
    #Warlock DoomFire
    if = { 
        limit = {
            check_variable = { which = "warlock_df_count" value >= 1}
        }
        change_variable = { which = "warlock_df_count" value = -1}
        subtract_variable = { which = "duel_hp" which = "warlock_df_dmg"}
    }
    if = { 
        limit =  {
            check_variable = { which = "warlock_df_count" value < 1}
        }
        set_variable = { which = "warlock_df_dmg" value = "0"}
        set_variable = { which = "warlock_df_count" value = "0"}
    }
    #Cleric Divine Blessing
    if = { 
        limit = {
            check_variable = { which = "cleric_db_count" value >= 1}
        }
        change_variable = { which = "cleric_db_count" value = -1}
    }
    if = { 
        limit =  {
            check_variable = { which = "cleric_db_count" value < 1}
        }
        set_variable = { which = "cleric_db_count" value = "0"}
        set_variable = { which = "cleric_db_pot" value = "0"}
    }
    #Druid Regrowth
    if = { 
        limit = {
            check_variable = { which = "druid_re_count" value >= 1}
        }
        change_variable = { which = "druid_re_count" value = -1}
        druid_regrowth_tick = yes
    }
    if = { 
        limit =  {
            check_variable = { which = "druid_re_count" value < 1}
        }
        set_variable = { which = "druid_re_count" value = "0"}
        set_variable = { which = "druid_re_pot" value = "0"}
    }
    #Druid Bear Skin
    if = { 
        limit = {
            check_variable = { which = "druid_bs_count" value >= 1}
        }
        change_variable = { which = "druid_bs_count" value = -1}
    }
    if = { 
        limit =  {
            check_variable = { which = "druid_bs_count" value < 1}
        }
        set_variable = { which = "druid_bs_count" value = "0"}
        set_variable = { which = "druid_bs_pot" value = "0"}
    }
    #Paladin Curative
    if = { 
        limit = {
            check_variable = { which = "paladin_cu_count" value >= 1}
        }
        change_variable = { which = "paladin_cu_count" value = -1}
        paladin_curative_tick = yes
    }
    if = { 
        limit =  {
            check_variable = { which = "paladin_cu_count" value < 1}
        }
        set_variable = { which = "paladin_cu_count" value = "0"}
        set_variable = { which = "paladin_cu_pot" value = "0"}
    }
    trigger_switch = { 
        on_trigger = has_character_flag
        cleric_heal_cantrip = { 
            cleric_heal_spell = yes
        }
        cleric_divine_blessing = { 
            cleric_divine_blessing_spell = yes
        }
        bard_embolden_song = { 
            bard_emboldening_song = yes
        }
        wizard_stone_skin_cantrip = { 
            wizard_stone_skin_cantrip = yes
        }
        druid_regrowth = { 
            druid_regrowth_spell = yes
        }
        druid_bear_skin = { 
            druid_bear_skin_spell = yes
        }
        paladin_curative = { 
            paladin_curative_spell = yes
        }
        paladin_larger_than_life = { 
            paladin_larger_than_life_spell = yes
        }
    }
}

duel_round_before_attack_effect = { 

}
duel_action_decision = { 
    event_target:attacker = { 
        trigger_switch = { 
            on_trigger = has_character_flag
            duel_action_attack = {
                duel_test = yes
            }        
            wizard_attack_cantrip = { 
                duel_test = yes
            }
            sorcerer_attack_cantrip = { 
                duel_test = yes
            }
            bard_dire_song = {
                bard_dire_song = yes
            }
            warlock_doomfire_cantrip = { 
                duel_test = yes
            }
            warlock_doom_blast_cantrip = { 
                duel_test = yes
            }
            druid_bear_strike = { 
                duel_test = yes
            }
            paladin_holy_smite = { 
                duel_test = yes
            }
        }
    }
}

duel_test = { 
    event_target:attacker = { 
        set_variable = { which = dnum value = 1  }
        z_d20 = yes
        set_variable = { which = duel_attack_roll which = dresult}
        set_variable = { which = dmgmod value = 0}
        z_duel_roll_modifier_attack = yes
        if = {
            limit = { 
                NOT =  {
                    check_variable = { which = duel_attack_roll value = 2}
                }
            }
            change_variable = { which = duel_attack_roll value = -7000} 
        }
        if = {
            limit = { 
                check_variable = { which = duel_attack_roll value = 20}
            }
            change_variable = { which = duel_attack_roll value = 5000} 
        }  
        change_variable = { which = duel_attack_roll which = duel_att}
        trigger_switch = { 
            on_trigger = has_character_flag
            duel_action_attack = {
            }        
            wizard_attack_cantrip = { 
                change_variable = {which = "duel_attack_roll" which = "wcl_sp"}
            }
            sorcerer_attack_cantrip = { 
                change_variable = {which = "duel_attack_roll" which = "scl_sp"}
            }
            druid_bear_strike = { 
                change_variable = {which = "duel_attack_roll" which = "dcl_sp"}
            }
        }
    }        
    event_target:defender = { 
        set_variable = { which = dnum value = 1 }
        z_d20 = yes
        set_variable = { which = duel_defend_roll which = dresult}
        z_duel_roll_modifier_defend = yes
        if = {
            limit = {
                not = { 
                    check_variable = { which = duel_defend_roll value = 2}
                }
            }
            change_variable = { which = duel_defend_roll value = -5000} 
        }
        if = {
            limit = { 
                check_variable = { which = duel_defend_roll value = 20}
            }
            change_variable = { which = duel_defend_roll value = 5000} 
        }        
        change_variable = { which = duel_defend_roll which = duel_def}
        trigger_switch = { 
            on_trigger = has_character_flag
            wizard_defend_cantrip = { 
                change_variable = { which = duel_defend_roll which = wcl_sp }
                change_variable = { which = duel_defend_roll value = 10 }
            }
            sorcerer_defend_cantrip = { 
                change_variable = { which = duel_defend_roll which = scl_sp }
                change_variable = { which = duel_defend_roll value = 10 }
            }
            fighter_parry = { 
                change_variable = { which = duel_defend_roll which = fal_ap }
                change_variable = { which = duel_defend_roll value = 20 }
            }
            ranger_parry = { 
                change_variable = { which = duel_defend_roll which = raal_ap }
                change_variable = { which = duel_defend_roll value = 10 }
            }
            barbarian_parry = { 
                change_variable = { which = duel_defend_roll which = bal_ap }
                change_variable = { which = duel_defend_roll value = 15 }
            }
            rogue_dodge = { 
                change_variable = { which = duel_defend_roll which = roal_ap }
                change_variable = { which = duel_defend_roll value = 15 }
            }
            assassin_dodge = { 
                change_variable = { which = duel_defend_roll which = aal_ap }
                change_variable = { which = duel_defend_roll value = 20 }
            }
            shadow_dodge = { 
                change_variable = { which = duel_defend_roll which = sal_ap }
                change_variable = { which = duel_defend_roll value = 10 }
            }
            duel_action_defend = { 
                change_variable = { which = duel_defend_roll value = 10 }
            }
        } 
    }   

    if = { 
        limit = {
            event_target:attacker = { 
                check_variable = { which = duel_attack_roll which >= duel_defend_roll which = event_target:defender } 
            }
        }
        event_target:attacker = {
            trigger_switch = {
                on_trigger = has_character_flag
                wizard_attack_cantrip = { 
                    wizard_attack_cantrip = yes
                    set_character_flag = duelhit
                    event_target:defender = { 
                        subtract_variable = { which = "duel_hp" which = "duel_dmg" which = event_target:attacker } 
                    }
                }
                sorcerer_attack_cantrip = { 
                    sorcerer_attack_cantrip = yes
                    set_character_flag = duelhit
                    event_target:defender = { 
                        subtract_variable = { which = "duel_hp" which = "duel_dmg" which = event_target:attacker } 
                    }
                }
                warlock_doomfire_cantrip = { 
                    warlock_doomfire_cantrip = yes
                    set_character_flag = duelhit
                    event_target:defender = { 
                        subtract_variable = { which = "duel_hp" which = "duel_dmg" which = event_target:attacker } 

                    }
                }
                warlock_doom_blast_cantrip = {
                    set_character_flag = duelhit
                    warlock_doomblast_cantrip = yes 
                    event_target:defender = { 
                        subtract_variable = { which = "duel_hp" which = "duel_dmg" which = event_target:attacker } 
                    }
                }
                druid_bear_strike  = {
                    druid_bear_strike_spell = yes 
                    set_character_flag = duelhit
                    event_target:defender = { 
                        subtract_variable = { which = "duel_hp" which = "duel_dmg" which = event_target:attacker } 
                        
                    }
                }
                paladin_holy_smite  = {
                    paladin_holy_smite_spell = yes 
                    set_character_flag = duelhit
                    event_target:defender = { 
                        subtract_variable = { which = "duel_hp" which = "duel_dmg" which = event_target:attacker } 
                        
                    }
                }
                duel_action_attack = {
                    duel_dmg = yes  
                    set_character_flag = duelhit
                    event_target:defender = { 
                        subtract_variable = { which = "duel_hp" which = "duel_dmg" which = event_target:attacker } 
                    }  
                }
            }
        }          
    }
}
#Wizard Spells
wizard_attack_cantrip = {
    clr_character_flag = resisted
    clr_character_flag = spell_fail
    event_target:attacker = {
        save_event_target_as = magic_caster
        z_wiz_setup = yes
    }
    event_target:defender = { 
        save_event_target_as = magic_target
        z_wiz_setup = yes
    }
    set_variable = {which = "splcastlvl" value = "10"}
    spellcast_modifer = yes
    set_variable = { which = dnum value = 1}
    wizard_cast_test = yes
    magic_resist_test = yes
    set_variable = { which = "local_spelldice" which = "wcl_sp" }
    divide_variable = { which = local_spelldice value = 5}
    divide_variable = { which = local_spelldice value = 1000}
    multiply_variable = { which = local_spelldice value = 1000}
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
            has_character_flag = resisted
        }
        set_variable = { which = "m_dd" value = 1 }
        set_variable = { which = mgdmgmod which = wcl_sp}
        duel_mgdmg = yes
    }
    if = { 
        limit = {
            nor = { 
                has_character_flag = spell_fail
                has_character_flag = resisted
            }
        }
        set_variable = { which = "m_dd" which = "local_spelldice" }
        change_variable = { which = "m_dd" value = 1 }
        set_variable = { which = mgdmgmod which = wcl_sp}
        duel_mgdmg = yes
    }           
}

wizard_stone_skin_cantrip = {
    clr_character_flag = spell_fail
    save_event_target_as = magic_caster
    z_wiz_setup = yes
    set_variable = {which = "splcastlvl" value = "15"}
    spellcast_modifer = yes

    set_variable = { which = dnum value = 1 }
    set_variable = { which = dnum_base which = dnum}
    wizard_cast_test = yes
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
        }
        set_variable = { which = "wizard_ss_count" which = "wcl_sp" }
        set_variable = { which = "local_wizard_ss_pot" which = "wcl_sp" }
        divide_variable = { which = local_wizard_ss_pot value = 5}
        divide_variable = { which = local_wizard_ss_pot value = 1000}
        multiply_variable = { which = local_wizard_ss_pot value = 1000}
        change_variable = { which = "local_wizard_ss_pot" value = 2 }  
        change_variable = { which = "wizard_ss_pot" which = "local_wizard_ss_pot"}
        change_variable = { which = "wizard_ss_count" value = 1 } 
    }           
}

#Sorcerer Spells
sorcerer_attack_cantrip = {
    clr_character_flag = resisted
    clr_character_flag = spell_fail
    event_target:attacker = {
        save_event_target_as = magic_caster
        z_sorc_setup = yes
    }
    event_target:defender = { 
        save_event_target_as = magic_target
        z_sorc_setup = yes
    }
    set_variable = {which = "splcastlvl" value = "10"}
    spellcast_modifer = yes
    set_variable = { which = dnum value = 1}
    wizard_cast_test = yes
    magic_resist_test = yes
    set_variable = { which = "local_spelldice" which = "scl_sp" }
    divide_variable = { which = local_spelldice value = 5}
    divide_variable = { which = local_spelldice value = 1000}
    multiply_variable = { which = local_spelldice value = 1000}
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
            has_character_flag = resisted
        }
        set_variable = { which = "m_dd" value = 1 }
        set_variable = { which = mgdmgmod which = scl_sp}
        duel_mgdmg = yes
    }
    if = { 
        limit = {
            nor = { 
                has_character_flag = spell_fail
                has_character_flag = resisted
            }
        }
        set_variable = { which = "m_dd" which = "local_spelldice" }
        change_variable = { which = "m_dd" value = 1 }
        set_variable = { which = mgdmgmod which = scl_sp}
        duel_mgdmg = yes
    }           
}

#Bard Spells 

bard_dire_song = {
    event_target:attacker = {
        save_event_target_as = magic_caster
    }
    event_target:defender = { 
        save_event_target_as = magic_target
        z_bard_setup = yes
    }
    set_variable = {which = "splcastlvl" value = "10"}
    spellcast_modifer = yes
    set_variable = { which = dnum value = 1}
    bard_cast_test = yes
    magic_resist_test = yes
    if = { 
        limit = {
            nor = { 
                has_character_flag = spell_fail
                has_character_flag = resisted
            }
        }
        event_target:defender = { 
            set_variable = { which = "bard_ds_count" which = "bcl_sp" which = event_target:magic_caster }
            change_variable = { which = "local_bard_ds_pot" which = "bcl_sp" which = event_target:magic_caster  }
            divide_variable = { which = local_bard_ds_pot value = 10}
            divide_variable = { which = local_bard_ds_pot value = 1000}
            multiply_variable = { which = local_bard_ds_pot value = 1000}
            change_variable = { which = "local_bard_ds_pot" value = 1 }
            change_variable = { which = "bard_ds_pot" which = "local_bard_ds_pot"}
            change_variable = { which = "bard_ds_count" value = 1 }
        }
    }           
    clr_character_flag = resisted
    clr_character_flag = spell_fail
}

bard_emboldening_song = {
    save_event_target_as = magic_caster
    set_variable = {which = "splcastlvl" value = "15"}
    spellcast_modifer = yes

    set_variable = { which = dnum value = 1 }
    set_variable = { which = dnum_base which = dnum}
    bard_cast_test = yes
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
        }
        set_variable = { which = "bard_es_count" which = "bcl_sp" }
        set_variable = { which = "local_bard_es_pot" which = "bcl_sp" }
        divide_variable = { which = local_bard_es_pot value = 10}
        divide_variable = { which = local_bard_es_pot value = 1000}
        multiply_variable = { which = local_bard_es_pot value = 1000}
        change_variable = { which = "local_bard_es_pot" value = 1 }  
        change_variable = { which = "bard_es_pot" which = "local_bard_es_pot"}
        change_variable = { which = "bard_es_count" value = 1 } 
    }           
    clr_character_flag = spell_fail
    clr_character_flag = miscast
}


#Warlock Spells 
warlock_doomblast_cantrip = {
    event_target:attacker = {
        save_event_target_as = magic_caster
        z_warl_setup = yes
    }
    event_target:defender = { 
        save_event_target_as = magic_target
        z_warl_setup = yes
    }
    set_variable = {which = "splcastlvl" value = "10"}
    spellcast_modifer = yes
    set_variable = { which = dnum value = 1}
    warlock_cast_test = yes
    magic_resist_test = yes
    set_variable = { which = "local_spelldice" which = "wacl_sp" }
    divide_variable = { which = local_spelldice value = 3}
    divide_variable = { which = local_spelldice value = 1000}
    multiply_variable = { which = local_spelldice value = 1000}
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
            has_character_flag = resisted
        }
        set_variable = { which = "m_dd" value = 1 }
        set_variable = { which = mgdmgmod which = wacl_sp}
        duel_mgdmg = yes
    }
    if = { 
        limit = {
            nor = { 
                has_character_flag = spell_fail
                has_character_flag = resisted
            }
        }
        set_variable = { which = "m_dd" which = "local_spelldice" }
        change_variable = { which = "m_dd" value = 1 }
        set_variable = { which = mgdmgmod which = wacl_sp}
        duel_mgdmg = yes
    }           
    clr_character_flag = resisted
    clr_character_flag = spell_fail
}

#Warlock_doomfire
warlock_doomfire_cantrip = {
    event_target:attacker = {
        save_event_target_as = magic_caster
        z_warl_setup = yes
    }
    event_target:defender = { 
        save_event_target_as = magic_target
        z_warl_setup = yes
    }
    set_variable = {which = "splcastlvl" value = "10"}
    spellcast_modifer = yes
    set_variable = { which = dnum value = 1}
    warlock_cast_test = yes
    magic_resist_test = yes
    set_variable = { which = "local_spelldice" which = "wacl_sp" }
    divide_variable = { which = local_spelldice value = 7}
    divide_variable = { which = local_spelldice value = 1000}
    multiply_variable = { which = local_spelldice value = 1000}
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
            has_character_flag = resisted
        }
        set_variable = { which = "m_dd" value = 1 }
        set_variable = { which = mgdmgmod which = wacl_sp}
        duel_mgdmg = yes
    }
    if = { 
        limit = {
            nor = { 
                has_character_flag = spell_fail
                has_character_flag = resisted
            }
        }
        set_variable = { which = "m_dd" which = "local_spelldice" }
        change_variable = { which = "m_dd" value = 1 }
        set_variable = { which = mgdmgmod which = wacl_sp}
        duel_mgdmg = yes
        event_target:defender = { 
            set_variable = { which = "warlock_df_count" which = "wacl_sp" which = event_target:magic_caster }
            change_variable = { which = "local_warlock_df_dmg" which = "wacl_sp" which = event_target:magic_caster  }
            divide_variable = { which = local_warlock_df_dmg value = 10}
            divide_variable = { which = local_warlock_df_dmg value = 1000}
            multiply_variable = { which = local_warlock_df_dmg value = 1000}
            change_variable = { which = "local_warlock_df_dmg" value = 1 }
            change_variable = { which = "warlock_df_dmg" which = "local_warlock_df_dmg"}
            change_variable = { which = "warlock_df_count" value = 1 }
        }
    }           
    clr_character_flag = resisted
    clr_character_flag = spell_fail
}

#Cleric Spells
cleric_heal_spell = {
    save_event_target_as = magic_caster
    event_target:defender = { 
        save_event_target_as = magic_target

    }
    set_variable = {which = "splcastlvl" value = "15"}
    spellcast_modifer = yes

    set_variable = { which = dnum value = 1}
    set_variable = { which = dnum_base which = dnum}
    set_variable = { which = "mhd" value = 0 }
    cleric_cast_test = yes
    set_variable = { which = "local_spelldice" which = "ccl_sp" }
    divide_variable = { which = local_spelldice value = 5}
    divide_variable = { which = local_spelldice value = 1000}
    multiply_variable = { which = local_spelldice value = 1000}
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
        }
        set_variable = { which = "mhd" which = "local_spelldice" }
        change_variable = { which = mhd value = 1 }
        set_variable = { which = mghealmod which = ccl_sp}
        cleric_heal_spell_heal_effect = yes
    }           
    clr_character_flag = spell_fail
    clr_character_flag = miscast
}

cleric_heal_spell_heal_effect = {
    set_variable = { which = dnum which = mhd}
    z_d6 = yes
    set_variable = { which = duel_heal which = dresult}
    change_variable = { which = duel_heal which = mghealmod}
    change_variable = { which = duel_hp which = duel_heal}
    If = { 
        limit = {
            check_variable = { which = duel_hp which = duel_max_hp}
        }
        set_variable = { which = duel_hp which = duel_max_hp}
    }
}


cleric_divine_blessing_spell = {
    save_event_target_as = magic_caster
    z_bard_setup = yes
    set_variable = {which = "splcastlvl" value = "15"}
    spellcast_modifer = yes

    set_variable = { which = dnum value = 1 }
    set_variable = { which = dnum_base which = dnum}
    cleric_cast_test = yes
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
        }
        set_variable = { which = "cleric_db_count" which = "ccl_sp" }
        set_variable = { which = "local_cleric_db_pot" which = "ccl_sp" }
        divide_variable = { which = local_cleric_db_pot value = 4}
        divide_variable = { which = local_cleric_db_pot value = 1000}
        multiply_variable = { which = local_cleric_db_pot value = 1000}
        change_variable = { which = "local_cleric_db_pot" value = 1 }  
        change_variable = { which = "cleric_db_pot" which = "local_cleric_db_pot"}
        change_variable = { which = "cleric_db_count" value = 1 } 
    }           
    clr_character_flag = spell_fail
    clr_character_flag = miscast
}


#druid Spells 

#lvl 1 
druid_bear_strike_spell = {
    set_variable = {which = "splcastlvl" value = "17"}
    spellcast_modifer = yes
    set_variable = { which = dnum value = 1}
    druid_cast_test = yes
    set_variable = { which = "local_attackdice" value = "dcl_sp" }
    divide_variable = { which = local_attackdice value = 5}
    divide_variable = { which = local_attackdice value = 1000}
    multiply_variable = { which = local_attackdice value = 1000}
    change_variable = { which = local_attackdice value = 1}
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
        }
        set_variable = { which = "dueldmgdice" which = "local_attackdice" }
        set_variable = { which = atdmgmod which = dcl_sp}
        duel_dmg = yes
    }         
    clr_character_flag = spell_fail
}

#lvl 3
druid_regrowth_spell = {
    save_event_target_as = magic_caster
    z_druid_setup = yes
    set_variable = {which = "splcastlvl" value = "20"}
    spellcast_modifer = yes

    set_variable = { which = dnum value = 1 }
    set_variable = { which = dnum_base which = dnum}
    druid_cast_test = yes
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
        }
        set_variable = { which = "druid_re_count" which = "dcl_sp" }
        set_variable = { which = "local_druid_re_pot" which = "dcl_sp" }
        divide_variable = { which = local_druid_re_pot value = 5}
        divide_variable = { which = local_druid_re_pot value = 1000}
        multiply_variable = { which = local_druid_re_pot value = 1000}
        change_variable = { which = "local_druid_re_pot" value = 1 }  
        change_variable = { which = "druid_re_pot" which = "local_druid_re_pot"}
        change_variable = { which = "druid_re_count" value = 1 } 
        druid_regrowth_tick = yes
    }           
    clr_character_flag = spell_fail
    clr_character_flag = miscast
}

druid_regrowth_tick = {
    set_variable = { which = dnum which = druid_re_pot}
    z_d3 = yes
    set_variable = { which = duel_heal which = dresult}
    change_variable = { which = duel_heal which = druid_re_pot}
    change_variable = { which = duel_hp which = duel_heal}
    If = { 
        limit = {
            check_variable = { which = duel_hp which = duel_max_hp}
        }
        set_variable = { which = duel_hp which = duel_max_hp}
    }
}

#lvl 7
druid_bear_skin_spell = {
    save_event_target_as = magic_caster
    z_druid_setup = yes
    set_variable = {which = "splcastlvl" value = "15"}
    spellcast_modifer = yes

    set_variable = { which = dnum value = 1 }
    set_variable = { which = dnum_base which = dnum}
    cleric_cast_test = yes
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
        }
        set_variable = { which = "druid_bs_count" which = "dcl_sp" }
        set_variable = { which = "local_cleric_db_pot" which = "dcl_sp" }
        divide_variable = { which = local_druid_bs_pot value = 10}
        divide_variable = { which = local_druid_bs_pot value = 1000}
        multiply_variable = { which = local_druid_bs_pot value = 1000}
        change_variable = { which = "local_druid_bs_pot" value = 2 }  
        change_variable = { which = "druid_bs_pot" which = "local_druid_bs_pot"}
        change_variable = { which = "druid_bs_count" value = 3 } 
    }           
    clr_character_flag = spell_fail
    clr_character_flag = miscast
}

#Lvl 10
druid_beastly_spell = {
    save_event_target_as = magic_caster
    z_druid_setup = yes
    set_variable = {which = "splcastlvl" value = "15"}
    spellcast_modifer = yes

    set_variable = { which = dnum value = 1 }
    set_variable = { which = dnum_base which = dnum}
    cleric_cast_test = yes
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
        }
        set_variable = { which = "cleric_db_count" which = "ccl_sp" }
        set_variable = { which = "local_cleric_db_pot" which = "ccl_sp" }
        divide_variable = { which = local_cleric_db_pot value = 4}
        divide_variable = { which = local_cleric_db_pot value = 1000}
        multiply_variable = { which = local_cleric_db_pot value = 1000}
        change_variable = { which = "local_cleric_db_pot" value = 1 }  
        change_variable = { which = "cleric_db_pot" which = "local_cleric_db_pot"}
        change_variable = { which = "cleric_db_count" value = 1 } 
    }           
    clr_character_flag = spell_fail
    clr_character_flag = miscast
}

#Paladin Spells 

paladin_holy_smite_spell = {
    set_variable = {which = "splcastlvl" value = "10"}
    spellcast_modifer = yes
    set_variable = { which = dnum value = 1}
    paladin_cast_test = yes
    set_variable = { which = "local_attackdice" value = "pcl_sp" }
    divide_variable = { which = local_attackdice value = 7}
    divide_variable = { which = local_attackdice value = 1000}
    multiply_variable = { which = local_attackdice value = 1000}
    change_variable = { which = local_attackdice value = 1}
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
        }
        set_variable = { which = "dueldmgdice" which = "local_attackdice" }
        set_variable = { which = atdmgmod which = pcl_sp}
        multiply_variable = { which = atdmgmod value = 2 }
        duel_dmg = yes
    }      
    clr_character_flag = spell_fail
}

paladin_curative_spell = {
    save_event_target_as = magic_caster
    z_paladin_setup = yes
    set_variable = {which = "splcastlvl" value = "20"}
    spellcast_modifer = yes

    set_variable = { which = dnum value = 1 }
    set_variable = { which = dnum_base which = dnum}
    paladin_cast_test = yes
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
        }
        set_variable = { which = "paladin_cu_count" which = "pcl_sp" }
        set_variable = { which = "local_paladin_cu_pot" which = "pcl_sp" }
        divide_variable = { which = local_paladin_cu_pot value = 3}
        divide_variable = { which = local_paladin_cu_pot value = 1000}
        multiply_variable = { which = local_paladin_cu_pot value = 1000}
        change_variable = { which = "local_paladin_cu_pot" value = 1 }  
        change_variable = { which = "paladin_cu_pot" which = "local_paladin_cu_pot"}
        change_variable = { which = "paladin_cu_count" value = 1 } 
        paladin_curative_tick = yes
    }           
    clr_character_flag = spell_fail
    clr_character_flag = miscast
}

paladin_curative_tick = {
    set_variable = { which = dnum which = paladin_cu_pot}
    z_d3 = yes
    set_variable = { which = duel_heal which = dresult}
    change_variable = { which = duel_heal which = paladin_cu_pot}
    change_variable = {which = duel_action_attack which = duel_heal }
    change_variable = {which = duel_action_defend which = duel_heal }
    change_variable = { which = duel_hp which = duel_heal}
    If = { 
        limit = {
            check_variable = { which = duel_hp which = duel_max_hp}
        }
        set_variable = { which = duel_hp which = duel_max_hp}
    }
}

paladin_larger_than_life_spell = {
    save_event_target_as = magic_caster
    z_paladin_setup = yes
    set_variable = {which = "splcastlvl" value = "15"}
    spellcast_modifer = yes

    set_variable = { which = dnum value = 1 }
    set_variable = { which = dnum_base which = dnum}
    paladin_cast_test = yes
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
        }
        set_variable = { which = "local_pala_ll_pot" which = "pcl_sp" }
        divide_variable = { which = local_pala_ll_pot value = 10}
        divide_variable = { which = local_pala_ll_pot value = 1000}
        multiply_variable = { which = local_pala_ll_pot value = 1000}
        change_variable = { which = "local_pala_ll_pot" value = 1 }  
        change_variable = { which = "pala_ll_pot" which = "local_pala_ll_pot"}
        change_variable = { which = "savemod" which = "local_pala_ll_pot"}
        change_variable = { which = "dmgmod" which = "local_pala_ll_pot"}
        multiply_variable = { which = local_pala_ll_pot value = 4}
        change_variable = { which = "duel_max_hp" which = "local_pala_ll_pot"}
    }           
    clr_character_flag = spell_fail
    clr_character_flag = miscast
}


#Fighter_Special_Attacks 
fighter_attack = {
    set_variable = {which = "splcastlvl" value = "10"}
    spellcast_modifer = yes
    set_variable = { which = dnum value = 1}
    wizard_cast_test = yes
    set_variable = { which = "local_attackdice" value = "fal_sp" }
    divide_variable = { which = local_attackdice value = 5}
    divide_variable = { which = local_attackdice value = 1000}
    multiply_variable = { which = local_attackdice value = 1000}
    if = { 
        limit = {
            not = { 
                has_character_flag = spell_fail
            }
        }
        set_variable = { which = "dueldmgdice" value = 1 }
        set_variable = { which = atdmgmod which = fal_sp}
        duel_dmg = yes
    }         
    clr_character_flag = spell_fail
}


#bonus_effect_calculation
savemod_calc = { 
    set_variable = { which = local_savemod which = savemod}        
    #Cleric Divine Blessing
    if = { 
        limit = { 
            check_variable = { which = cleric_db_count value = 1}
        }
        change_variable = { which = local_savemod which = cleric_db_pot}
    }
    #Druid Bear Skin
    if = { 
        limit = { 
            check_variable = { which = druid_bs_count value = 1}
        }
        change_variable = { which = local_savemod which = druid_bs_pot}
    }

    set_variable = { which = savemodcal which = local_savemod}
}

dmgmod_calc = { 
    set_variable = { which = local_savemod which = savemod}        


    set_variable = { which = savemodcal which = local_savemod}
}

#Effect Application
duel_dmg = {
    set_variable = { which = dnum which = dueldmgdice}
    z_d4 = yes
    set_variable = { which = duel_dmg which = dresult}
    change_variable = { which = duel_dmg which = atdmgmod }
    change_variable = { which = duel_dmg which = dmgmod }
    change_variable = { which = duel_dmg which = cls_dmg_bonus }
    event_target:defender = { savemod_calc = yes}
    subtract_variable = { which = duel_dmg which = savemodcal which = event_target:defender}
    if = { 
        limit = { 
            not = { 
                check_variable ={ which = duel_dmg value = 0}
            }
        }
        set_variable = { which  = duel_dmg value = 0}
    }
}
duel_mgdmg = {
    set_variable = { which = dnum which = "m_dd"}
    z_d3 = yes
    set_variable = { which = duel_dmg which = dresult}
    change_variable = { which = duel_dmg which = mgdmgmod}
    event_target:defender = { savemod_calc = yes}
    subtract_variable = { which = duel_dmg which = savemodcal which = event_target:defender}
     if = { 
        limit = { 
            not = { 
                check_variable ={ which = duel_dmg value = 0}
            }
        } 
        set_variable = { which  = duel_dmg value = 0}
    }    
}
duel_mgheal = {
    set_variable = { which = dnum which = mhd}
    z_d3 = yes
    set_variable = { which = duel_heal which = dresult}
    change_variable = { which = duel_heal which = mghealmod}
    change_variable = { which = duel_hp which = duel_heal}
    If = { 
        limit = {
            check_variable = { which = duel_hp which = duel_max_hp}
        }
        set_variable = { which = duel_hp which = duel_max_hp}
    }
}