magic_targeting_setup = {

}

z_wiz_setup = { 
	z_wizlvl_calc = yes
	set_variable = { which = "magical_resistance" value = 0 }
	set_variable = { which = "magical_penetration" value = 0 }
	set_variable = { which = "magic_dispel" value = 0 }
	change_variable = { which = "magic_dispel" which = "wizlvl"}
	change_variable = { which = "magical_resistance" which = "wizlvl" }
	change_variable = { which = "magical_penetration" which = "wizlvl" }
	set_variable = { which = "wcl" which = "wizlvl"}
	set_variable = { which = "wcl_sp" which = "wcl" }
	z_itemization = yes
}
z_bard_setup = { 
	z_bardlvl_calc = yes
	set_variable = { which = "magical_resistance" value = 0 }
	set_variable = { which = "magical_penetration" value = 0 }
	set_variable = { which = "magic_dispel" value = 0 }
	change_variable = { which = "magic_dispel" which = "bardlvl"}
	change_variable = { which = "magical_resistance" which = "bardlvl" }
	change_variable = { which = "magical_penetration" which = "bardlvl" }
	set_variable = { which = "bcl" which = "bardlvl"}
	set_variable = { which = "bcl_sp" which = "bcl" }
	z_itemization = yes
}
z_warl_setup = { 
	z_warllvl_calc = yes
	set_variable = { which = "magical_resistance" value = 0 }
	set_variable = { which = "magical_penetration" value = 0 }
	set_variable = { which = "magic_dispel" value = 0 }
	change_variable = { which = "magic_dispel" which = "warllvl"}
	change_variable = { which = "magical_resistance" which = "warllvl" }
	change_variable = { which = "magical_penetration" which = "warllvl" }
	set_variable = { which = "wacl" which = "warllvl"}
	set_variable = { which = "wacl_sp" which = "wacl" }
	z_itemization = yes
}
z_sorc_setup = { 
	z_sorclvl_calc = yes
	set_variable = { which = "magical_resistance" value = 0 }
	set_variable = { which = "magical_penetration" value = 0 }
	set_variable = { which = "magic_dispel" value = 0 }
	change_variable = { which = "magic_dispel" which = "sorclvl"}
	change_variable = { which = "magical_resistance" which = "sorclvl" }
	change_variable = { which = "magical_penetration" which = "sorclvl" }
	set_variable = { which = "scl" which = "sorclvl"}
	set_variable = { which = "scl_sp" which = "scl" }
	z_itemization = yes
}
z_cleric_setup = { 
	z_clerlvl_calc = yes
	set_variable = { which = "magical_resistance" value = 0 }
	set_variable = { which = "magical_penetration" value = 0 }
	set_variable = { which = "magic_dispel" value = 0 }
	change_variable = { which = "magic_dispel" which = "clerlvl"}
	change_variable = { which = "magical_resistance" which = "clerlvl" }
	change_variable = { which = "magical_penetration" which = "clerlvl" }
	set_variable = { which = "ccl" which = "clerlvl"}
	set_variable = { which = "ccl_sp" which = "ccl" }
	z_itemization = yes
}
z_druid_setup = { 
	z_druilvl_calc = yes
	set_variable = { which = "magical_resistance" value = 0 }
	set_variable = { which = "magical_penetration" value = 0 }
	set_variable = { which = "magic_dispel" value = 0 }
	change_variable = { which = "magic_dispel" which = "druilvl"}
	change_variable = { which = "magical_resistance" which = "druilvl" }
	change_variable = { which = "magical_penetration" which = "druilvl" }
	set_variable = { which = "dcl" which = "druilvl"}
	set_variable = { which = "dcl_sp" which = "dcl" }
	z_itemization = yes
}

z_paladin_setup = { 
	z_palalvl_calc = yes
	set_variable = { which = "pcl" which = "palalvl"}
	set_variable = { which = "pcl_sp" which = "pcl" }
	z_itemization = yes
}

z_fighter_setup = { 
	z_fighlvl_calc = yes
	set_variable = { which = "fal" which = "fighlvl"}
	set_variable = { which = "fal_ap" which = "fal" }
	z_itemization = yes
}
z_barbarian_setup = { 
	z_barblvl_calc = yes
	set_variable = { which = "fal" which = "fighlvl"}
	set_variable = { which = "fal_ap" which = "fal" }
	z_itemization = yes
}
z_ranger_setup = { 
	z_ranglvl_calc = yes
	set_variable = { which = "raal" which = "ranglvl"}
	set_variable = { which = "raal_ap" which = "raal" }
	z_itemization = yes
}

z_rogue_setup = { 
	z_rogulvl_calc = yes
	set_variable = { which = "roal" which = "rogulvl"}
	set_variable = { which = "roal_ap" which = "roal" }
	z_itemization = yes
}
z_shadow_setup = { 
	z_shadlvl_calc = yes
	set_variable = { which = "sal" which = "shadlvl"}
	set_variable = { which = "sal_ap" which = "sal" }
	z_itemization = yes
}
z_assassin_setup = { 
	z_assalvl_calc = yes
	set_variable = { which = "aal" which = "assalvl"}
	set_variable = { which = "aal_ap" which = "aal" }
	z_itemization = yes
}

z_itemization = { 

}

z_calc_spell_slots_wizard = { 
	if = { 
		limit = { 
			check_variable = { which = "wizlvl" value = "0"}
		}
		set_variable = { which = "ss_1_m_wiz" value = "1"}
	}
	if = { 
		limit = { 
			check_variable = { which = "wizlvl" value = "5"}
		}
		set_variable = { which = "ss_2_m_wiz" value = "1"}
		set_variable = { which = "ss_1_m_wiz" value = "2"}
	}
	if = { 
		limit = { 
			check_variable = { which = "wizlvl" value = "10"}
		}
		set_variable = { which = "ss_3_m_wiz" value = "1"}
		set_variable = { which = "ss_2_m_wiz" value = "2"}
		set_variable = { which = "ss_1_m_wiz" value = "3"}
	}
	if = { 
		limit = { 
			check_variable = { which = "wizlvl" value = "15"}
		}
		set_variable = { which = "ss_4_m_wiz" value = "1"}
		set_variable = { which = "ss_3_m_wiz" value = "2"}
		set_variable = { which = "ss_2_m_wiz" value = "3"}
		set_variable = { which = "ss_1_m_wiz" value = "4"}
	}
	if = { 
		limit = { 
			check_variable = { which = "wizlvl" value = "20"}
		}
		set_variable = { which = "ss_5_m_wiz" value = "1"}
		set_variable = { which = "ss_4_m_wiz" value = "2"}
		set_variable = { which = "ss_3_m_wiz" value = "3"}
		set_variable = { which = "ss_2_m_wiz" value = "4"}
		set_variable = { which = "ss_1_m_wiz" value = "5"}
	}
	if = { 
		limit = { 
			check_variable = { which = "wizlvl" value = "25"}
		}
		set_variable = { which = "ss_5_m_wiz" value = "2"}
		set_variable = { which = "ss_4_m_wiz" value = "3"}
		set_variable = { which = "ss_3_m_wiz" value = "4"}
		set_variable = { which = "ss_2_m_wiz" value = "5"}
		set_variable = { which = "ss_1_m_wiz" value = "6"}		
	}	
	if = { 
		limit = { 
			check_variable = { which = "wizlvl" value = "30"}
		}
		set_variable = { which = "ss_5_m_wiz" value = "3"}
		set_variable = { which = "ss_4_m_wiz" value = "4"}
		set_variable = { which = "ss_3_m_wiz" value = "5"}
		set_variable = { which = "ss_2_m_wiz" value = "6"}
		set_variable = { which = "ss_1_m_wiz" value = "7"}	
	}
	if = { 
		limit = { 
			check_variable = { which = "wizlvl" value = "35"}
		}
		set_variable = { which = "ss_5_m_wiz" value = "4"}
		set_variable = { which = "ss_4_m_wiz" value = "5"}
		set_variable = { which = "ss_3_m_wiz" value = "6"}
		set_variable = { which = "ss_2_m_wiz" value = "7"}
		set_variable = { which = "ss_1_m_wiz" value = "8"}	
	}
	if = { 
		limit = { 
			check_variable = { which = "wizlvl" value = "40"}
		}
		set_variable = { which = "ss_5_m_wiz" value = "5"}
		set_variable = { which = "ss_4_m_wiz" value = "6"}
		set_variable = { which = "ss_3_m_wiz" value = "7"}
		set_variable = { which = "ss_2_m_wiz" value = "8"}
		set_variable = { which = "ss_1_m_wiz" value = "9"}	
	}
	if = { 
		limit = { 
			check_variable = { which = "wizlvl" value = "45"}
		}
		set_variable = { which = "ss_5_m_wiz" value = "6"}
		set_variable = { which = "ss_4_m_wiz" value = "7"}
		set_variable = { which = "ss_3_m_wiz" value = "8"}
		set_variable = { which = "ss_2_m_wiz" value = "9"}
		set_variable = { which = "ss_1_m_wiz" value = "9"}	
	}
	if = { 
		limit = { 
			check_variable = { which = "wizlvl" value = "50"}
		}
		set_variable = { which = "ss_5_m_wiz" value = "7"}
		set_variable = { which = "ss_4_m_wiz" value = "8"}
		set_variable = { which = "ss_3_m_wiz" value = "9"}
		set_variable = { which = "ss_2_m_wiz" value = "9"}
		set_variable = { which = "ss_1_m_wiz" value = "9"}	
	}
}

z_spell_slots_refresh_wizard = { 
	z_calc_spell_slots_wizard = yes
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_1_wiz" which = "ss_1_m_wiz"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_1_wiz" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_1_wiz" which = "ss_1_m_wiz"}	
			}
			set_variable = { which = "ss_1_wiz" which = "ss_1_m_wiz"}
		}
	}
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_2_wiz" which = "ss_2_m_wiz"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_2_wiz" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_2_wiz" which = "ss_2_m_wiz"}	
			}
			set_variable = { which = "ss_2_wiz" which = "ss_2_m_wiz"}
		}
	}
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_3_wiz" which = "ss_3_m_wiz"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_3_wiz" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_3_wiz" which = "ss_3_m_wiz"}	
			}
			set_variable = { which = "ss_3_wiz" which = "ss_3_m_wiz"}
		}
	}
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_4_wiz" which = "ss_4_m_wiz"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_4_wiz" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_4_wiz" which = "ss_4_m_wiz"}	
			}
			set_variable = { which = "ss_4_wiz" which = "ss_4_m_wiz"}
		}
	}
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_5_wiz" which = "ss_5_m_wiz"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_5_wiz" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_5_wiz" which = "ss_5_m_wiz"}	
			}
			set_variable = { which = "ss_5_wiz" which = "ss_5_m_wiz"}
		}
	}
}

#calculate Cleric Spell Slots
z_calc_spell_slots_cleric = { 
	if = { 
		limit = { 
			check_variable = { which = "clerlvl" value = "0"}
		}
		set_variable = { which = "ss_1_m_cler" value = "1"}
	}
	if = { 
		limit = { 
			check_variable = { which = "clerlvl" value = "5"}
		}
		set_variable = { which = "ss_2_m_cler" value = "1"}
		set_variable = { which = "ss_1_m_cler" value = "2"}
	}
	if = { 
		limit = { 
			check_variable = { which = "clerlvl" value = "10"}
		}
		set_variable = { which = "ss_3_m_cler" value = "1"}
		set_variable = { which = "ss_2_m_cler" value = "2"}
		set_variable = { which = "ss_1_m_cler" value = "3"}
	}
	if = { 
		limit = { 
			check_variable = { which = "clerlvl" value = "15"}
		}
		set_variable = { which = "ss_4_m_cler" value = "1"}
		set_variable = { which = "ss_3_m_cler" value = "2"}
		set_variable = { which = "ss_2_m_cler" value = "3"}
		set_variable = { which = "ss_1_m_cler" value = "4"}
	}
	if = { 
		limit = { 
			check_variable = { which = "clerlvl" value = "20"}
		}
		set_variable = { which = "ss_5_m_cler" value = "1"}
		set_variable = { which = "ss_4_m_cler" value = "2"}
		set_variable = { which = "ss_3_m_cler" value = "3"}
		set_variable = { which = "ss_2_m_cler" value = "4"}
		set_variable = { which = "ss_1_m_cler" value = "5"}
	}
	if = { 
		limit = { 
			check_variable = { which = "clerlvl" value = "25"}
		}
		set_variable = { which = "ss_5_m_cler" value = "2"}
		set_variable = { which = "ss_4_m_cler" value = "3"}
		set_variable = { which = "ss_3_m_cler" value = "4"}
		set_variable = { which = "ss_2_m_cler" value = "5"}
		set_variable = { which = "ss_1_m_cler" value = "6"}		
	}	
	if = { 
		limit = { 
			check_variable = { which = "clerlvl" value = "30"}
		}
		set_variable = { which = "ss_5_m_cler" value = "3"}
		set_variable = { which = "ss_4_m_cler" value = "4"}
		set_variable = { which = "ss_3_m_cler" value = "5"}
		set_variable = { which = "ss_2_m_cler" value = "6"}
		set_variable = { which = "ss_1_m_cler" value = "7"}	
	}
	if = { 
		limit = { 
			check_variable = { which = "clerlvl" value = "35"}
		}
		set_variable = { which = "ss_5_m_cler" value = "4"}
		set_variable = { which = "ss_4_m_cler" value = "5"}
		set_variable = { which = "ss_3_m_cler" value = "6"}
		set_variable = { which = "ss_2_m_cler" value = "7"}
		set_variable = { which = "ss_1_m_cler" value = "8"}	
	}
	if = { 
		limit = { 
			check_variable = { which = "clerlvl" value = "40"}
		}
		set_variable = { which = "ss_5_m_cler" value = "5"}
		set_variable = { which = "ss_4_m_cler" value = "6"}
		set_variable = { which = "ss_3_m_cler" value = "7"}
		set_variable = { which = "ss_2_m_cler" value = "8"}
		set_variable = { which = "ss_1_m_cler" value = "9"}	
	}
	if = { 
		limit = { 
			check_variable = { which = "clerlvl" value = "45"}
		}
		set_variable = { which = "ss_5_m_cler" value = "6"}
		set_variable = { which = "ss_4_m_cler" value = "7"}
		set_variable = { which = "ss_3_m_cler" value = "8"}
		set_variable = { which = "ss_2_m_cler" value = "9"}
		set_variable = { which = "ss_1_m_cler" value = "9"}	
	}
	if = { 
		limit = { 
			check_variable = { which = "clerlvl" value = "50"}
		}
		set_variable = { which = "ss_5_m_cler" value = "7"}
		set_variable = { which = "ss_4_m_cler" value = "8"}
		set_variable = { which = "ss_3_m_cler" value = "9"}
		set_variable = { which = "ss_2_m_cler" value = "9"}
		set_variable = { which = "ss_1_m_cler" value = "9"}	
	}
}
#refresh Cleric Spell Slots
z_spell_slots_refresh_cleric = { 
	z_calc_spell_slots_cleric = yes
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_1_cler" which = "ss_1_m_cler"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_1_cler" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_1_cler" which = "ss_1_m_cler"}	
			}
			set_variable = { which = "ss_1_cler" which = "ss_1_m_cler"}
		}
	}
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_2_cler" which = "ss_2_m_cler"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_2_cler" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_2_cler" which = "ss_2_m_cler"}	
			}
			set_variable = { which = "ss_2_cler" which = "ss_2_m_cler"}
		}
	}
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_3_cler" which = "ss_3_m_cler"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_3_cler" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_3_cler" which = "ss_3_m_cler"}	
			}
			set_variable = { which = "ss_3_cler" which = "ss_3_m_cler"}
		}
	}
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_4_cler" which = "ss_4_m_cler"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_4_cler" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_4_cler" which = "ss_4_m_cler"}	
			}
			set_variable = { which = "ss_4_cler" which = "ss_4_m_cler"}
		}
	}
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_5_cler" which = "ss_5_m_cler"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_5_cler" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_5_cler" which = "ss_5_m_cler"}	
			}
			set_variable = { which = "ss_5_cler" which = "ss_5_m_cler"}
		}
	}
}


#calc Druid Spell Slots
z_calc_spell_slots_druid = { 
	if = { 
		limit = { 
			check_variable = { which = "druilvl" value = "0"}
		}
		set_variable = { which = "ss_1_m_drui" value = "1"}
	}
	if = { 
		limit = { 
			check_variable = { which = "druilvl" value = "5"}
		}
		set_variable = { which = "ss_2_m_drui" value = "1"}
		set_variable = { which = "ss_1_m_drui" value = "2"}
	}
	if = { 
		limit = { 
			check_variable = { which = "druilvl" value = "10"}
		}
		set_variable = { which = "ss_3_m_drui" value = "1"}
		set_variable = { which = "ss_2_m_drui" value = "2"}
		set_variable = { which = "ss_1_m_drui" value = "3"}
	}
	if = { 
		limit = { 
			check_variable = { which = "druilvl" value = "15"}
		}
		set_variable = { which = "ss_4_m_drui" value = "1"}
		set_variable = { which = "ss_3_m_drui" value = "2"}
		set_variable = { which = "ss_2_m_drui" value = "3"}
		set_variable = { which = "ss_1_m_drui" value = "4"}
	}
	if = { 
		limit = { 
			check_variable = { which = "druilvl" value = "20"}
		}
		set_variable = { which = "ss_5_m_drui" value = "1"}
		set_variable = { which = "ss_4_m_drui" value = "2"}
		set_variable = { which = "ss_3_m_drui" value = "3"}
		set_variable = { which = "ss_2_m_drui" value = "4"}
		set_variable = { which = "ss_1_m_drui" value = "5"}
	}
	if = { 
		limit = { 
			check_variable = { which = "druilvl" value = "25"}
		}
		set_variable = { which = "ss_5_m_drui" value = "2"}
		set_variable = { which = "ss_4_m_drui" value = "3"}
		set_variable = { which = "ss_3_m_drui" value = "4"}
		set_variable = { which = "ss_2_m_drui" value = "5"}
		set_variable = { which = "ss_1_m_drui" value = "6"}		
	}	
	if = { 
		limit = { 
			check_variable = { which = "druilvl" value = "30"}
		}
		set_variable = { which = "ss_5_m_drui" value = "3"}
		set_variable = { which = "ss_4_m_drui" value = "4"}
		set_variable = { which = "ss_3_m_drui" value = "5"}
		set_variable = { which = "ss_2_m_drui" value = "6"}
		set_variable = { which = "ss_1_m_drui" value = "7"}	
	}
	if = { 
		limit = { 
			check_variable = { which = "druilvl" value = "35"}
		}
		set_variable = { which = "ss_5_m_drui" value = "4"}
		set_variable = { which = "ss_4_m_drui" value = "5"}
		set_variable = { which = "ss_3_m_drui" value = "6"}
		set_variable = { which = "ss_2_m_drui" value = "7"}
		set_variable = { which = "ss_1_m_drui" value = "8"}	
	}
	if = { 
		limit = { 
			check_variable = { which = "druilvl" value = "40"}
		}
		set_variable = { which = "ss_5_m_drui" value = "5"}
		set_variable = { which = "ss_4_m_drui" value = "6"}
		set_variable = { which = "ss_3_m_drui" value = "7"}
		set_variable = { which = "ss_2_m_drui" value = "8"}
		set_variable = { which = "ss_1_m_drui" value = "9"}	
	}
	if = { 
		limit = { 
			check_variable = { which = "druilvl" value = "45"}
		}
		set_variable = { which = "ss_5_m_drui" value = "6"}
		set_variable = { which = "ss_4_m_drui" value = "7"}
		set_variable = { which = "ss_3_m_drui" value = "8"}
		set_variable = { which = "ss_2_m_drui" value = "9"}
		set_variable = { which = "ss_1_m_drui" value = "9"}	
	}
	if = { 
		limit = { 
			check_variable = { which = "druilvl" value = "50"}
		}
		set_variable = { which = "ss_5_m_drui" value = "7"}
		set_variable = { which = "ss_4_m_drui" value = "8"}
		set_variable = { which = "ss_3_m_drui" value = "9"}
		set_variable = { which = "ss_2_m_drui" value = "9"}
		set_variable = { which = "ss_1_m_drui" value = "9"}	
	}
}

#refresh druid spell slots

z_spell_slots_refresh_druid = { 
	z_calc_spell_slots_druid = yes
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_1_drui" which = "ss_1_m_drui"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_1_drui" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_1_drui" which = "ss_1_m_drui"}	
			}
			set_variable = { which = "ss_1_drui" which = "ss_1_m_drui"}
		}
	}
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_2_drui" which = "ss_2_m_drui"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_2_drui" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_2_drui" which = "ss_2_m_drui"}	
			}
			set_variable = { which = "ss_2_drui" which = "ss_2_m_drui"}
		}
	}
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_3_drui" which = "ss_3_m_drui"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_3_drui" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_3_drui" which = "ss_3_m_drui"}	
			}
			set_variable = { which = "ss_3_drui" which = "ss_3_m_drui"}
		}
	}
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_4_drui" which = "ss_4_m_drui"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_4_drui" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_4_drui" which = "ss_4_m_drui"}	
			}
			set_variable = { which = "ss_4_drui" which = "ss_4_m_drui"}
		}
	}
	if = {
		limit = { 
			not = { 
				check_variable = {which ="ss_5_drui" which = "ss_5_m_drui"}
			}
		}
		set_variable = { which = "dnum" value = "1"}
		z_d4 = yes
		change_variable ={ which = "dresult" value = "-1"}
		change_variable = { which = "ss_5_drui" which = "dresult"}
		if = { 
			limit = { 
				check_variable = {which ="ss_5_drui" which = "ss_5_m_drui"}	
			}
			set_variable = { which = "ss_5_drui" which = "ss_5_m_drui"}
		}
	}
}

z_metamagic_setup = { 
	event_target:magic_caster = {
		set_variable = { which  = "action_nr" value = "0" }
       	set_variable = { which = "action_picked" value = "1" }
       	clr_character_flag = metamagic_maximize
       	clr_character_flag = metamagic_widen
       	clr_character_flag = metamagic_extend
       	clr_character_flag = metamagic_repeat
       	if = {
       		limit = { 
       			OR = {
                    AND = { 
                        check_variable == { which = "spell_slot_cast" value = 0 }
                        check_variable = { which = "ss_1_wiz" value = 1 }
                           
                    } 
                    AND = {
                        check_variable == { which = "spell_slot_cast" value = 1 }
                        check_variable = { which = "ss_2_wiz" value = 1 }
                           
                    }
                    AND = {
                        check_variable == { which = "spell_slot_cast" value = 2 }
                        check_variable = { which = "ss_3_wiz" value = 1 }
                           
                    }
                    AND = {
                        check_variable == { which = "spell_slot_cast" value = 3 }
                        check_variable = { which = "ss_4_wiz" value = 1 }
                           
                    }
                    AND = {
                        check_variable == { which = "spell_slot_cast" value = 4 }
                        check_variable = { which = "ss_5_wiz" value = 1 }
                    }
                }
       		}
			if = { 
				limit = { 
					has_character_flag = known_metamagic_maximize
				}
				change_variable = { which = "action_nr" value = "1" } 
	            set_variable = { which = "mm_maximize" which = "action_nr" } 
			}
			if = { 
				limit = { 
					has_character_flag = known_metamagic_widen
				}
				change_variable = { which = "action_nr" value = "1" } 
	            set_variable = { which = "mm_widen" which = "action_nr" } 
			}
			if = { 
				limit = { 
					has_character_flag = known_metamagic_extend
				}
				change_variable = { which = "action_nr" value = "1" } 
	            set_variable = { which = "mm_extend" which = "action_nr" } 
			}
			if = { 
				limit = { 
					has_character_flag = known_metamagic_repeat
				}
				change_variable = { which = "action_nr" value = "1" } 
	            set_variable = { which = "mm_repeat" which = "action_nr" } 
			}
		}
		change_variable = { which = "action_nr" value = "1" } 
        set_variable = { which = "mm_none" which = "action_nr" } 
    }
}

z_wiz_spell_process = { 	
	if = {
		limit = {
			event_target:magic_caster = {
				has_character_flag = dispeled
			}
		}
		event_target:magic_caster = { clr_character_flag = dispeled}
		character_event = { id = z_wiz_spell_menu.99996}
	}
	if = {
		limit = {
			event_target:magic_caster = { has_character_flag = spell_fail }
		}
		character_event = {id = magic_system.99992}#If has the miscast flag, skip to the miscast event table
		event_target:magic_caster = { clr_character_flag = spell_fail}
	}	
}

